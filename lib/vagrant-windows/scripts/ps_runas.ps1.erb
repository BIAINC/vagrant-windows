Set-ExecutionPolicy Unrestricted -force;

function ps-runas ([String] $user, [String] $password, [String] $cmd, [String] $arguments)
{
  schtasks /query /tn "chef-solo"
  if (!$?) {
    schtasks /create /tn "chef-solo" /tr "powershell -file c:\tmp\run_chef.ps1" /sc once /st 12:00 /sd 01/01/2045 /ru $user /rp $password /rl HIGHEST
    #schtasks /delete /tn "chef-solo" /f
    #TODO: create task using XML so it'll run if the host is a laptop running on batteries
  }
  
  # start the scheduled task right now
  schtasks /run /tn "chef-solo"
  
  # wait for run_chef.ps1 to start
  Start-Sleep -s 2
  
  # read the entire file, but only write out new lines we haven't seen before
  $numLinesRead = 0
  $success = $TRUE
  while (Test-Path c:\tmp\chef-solo.running) {
    Start-Sleep -m 100
    
    $text = (get-content "c:\tmp\chef-solo.log")
    $numLines = ($text | Measure-Object -line).lines    
    $numLinesToRead = $numLines - $numLinesRead
    
    $text | select -first $numLinesToRead -skip $numLinesRead | ForEach {
      if ("$_".contains("ERROR: Running exception handlers")) {
        $success = $FALSE
      }
      Write-Host "$_"
    }
    $numLinesRead += $numLinesToRead
  }
  
  if ($success) {
    exit 0
  }
  exit -1

}

ps-runas "<%= options[:user] %>" "<%= options[:password] %>" "<%= options[:cmd] %>" "<%= options[:arguments] %>"
